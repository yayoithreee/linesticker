<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: sans-serif; margin:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:20px; }
.card { border:1px solid #ddd; padding:10px; }
img { width:100%; }
.author-links { font-size:12px; margin-bottom:15px; }
input { width:100%; padding:6px; margin:15px 0; }
button { margin-right:10px; }
</style>
</head>
<body>

<h2>LINEスタンプ一覧</h2>

<button onclick="setView('all')">すべて</button>
<button onclick="setView('author')">作者別</button>

<input type="text" id="search" placeholder="検索">

<div id="authorInfo"></div>
<div id="app"></div>

<script>

let allItems = [];
let currentView = "all";

google.script.run.withSuccessHandler(data=>{
  allItems = data;
  init();
}).getData();

function init(){
  const params = new URLSearchParams(window.location.search);
  currentView = params.get("view") || "all";
  const author = params.get("author");

  if(author){
    showAuthor(author);
  } else {
    render(allItems);
  }
}

function setView(view){
  const url = new URL(window.location);
  url.searchParams.set("view", view);
  url.searchParams.delete("author");
  window.location = url;
}

function render(data){
  const app = document.getElementById("app");
  app.innerHTML = '<div class="grid">' +
    data.map(item => cardHTML(item)).join("") +
    '</div>';
}

function cardHTML(item){
  const safeUrl = item.url ? item.url.trim() : "#";
  return `
    <div class="card">
      <a href="${encodeURI(safeUrl)}" target="_blank">
        <img src="https://stickershop.line-scdn.net/stickershop/v1/product/${extractId(safeUrl)}/LINEStorePC/main.png">
      </a>
      <div>${item.title || ""}</div>
      <div style="color:blue;cursor:pointer" onclick="showAuthor('${item.author}')">
        ${item.author}
      </div>
    </div>
  `;
}

function extractId(url){
  const match = url.match(/product\/(\d+)/);
  if(match) return match[1];

  const match2 = url.match(/sticker\/(\d+)/);
  if(match2) return match2[1];

  return "";
}

function showAuthor(name){
  const filtered = allItems.filter(i=>i.author===name);
  render(filtered);

  const info = filtered[0];

  document.getElementById("authorInfo").innerHTML = `
    <div class="author-links">
      <a href="${info.lineCreatorUrl}" target="_blank">LINE</a> |
      ${info.snsName || ""} |
      <a href="${info.xUrl}" target="_blank">X</a> |
      <a href="${info.threadsUrl}" target="_blank">Threads</a>
    </div>
  `;

  const url = new URL(window.location);
  url.searchParams.set("author", name);
  window.history.pushState({}, "", url);
}

document.getElementById("search").addEventListener("input", e=>{
  const q = e.target.value.toLowerCase();
  const filtered = allItems.filter(i =>
    (i.title || "").toLowerCase().includes(q) ||
    (i.author || "").toLowerCase().includes(q)
  );
  render(filtered);
});

</script>
</body>
</html>
