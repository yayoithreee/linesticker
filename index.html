<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEスタンプ一覧</title>

<style>
*{box-sizing:border-box}
body{font-family:'Helvetica Neue',Arial,'Hiragino Kaku Gothic ProN',sans-serif;margin:0;background:#fafafa;color:#333}

header{padding:20px 24px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10}
h1{margin:0 0 12px;font-size:22px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:8px 18px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;font-size:14px;transition:.2s}
button:hover{background:#f0f0f0}
button.active{background:#06C755;color:#fff;border-color:#06C755}
input{padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:14px;min-width:180px}

main{max-width:1100px;margin:0 auto;padding:20px}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px}

.stamp-card a{display:block;text-decoration:none;color:inherit}
.stamp-card img{width:100%;border-radius:10px;display:block}
.stamp-card .stamp-name{font-size:12px;margin-top:6px;color:#555}

/* 作者別セクション */
.author-section{background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;margin-bottom:24px}
.author-header{margin-bottom:14px}
.author-name{font-weight:bold;font-size:16px}
.author-name a{color:#06C755;text-decoration:none}
.author-name a:hover{text-decoration:underline}
.author-meta{font-size:12px;color:#888;margin-top:4px}
.author-meta a{color:#888;text-decoration:none;margin-right:10px}
.author-meta a:hover{color:#06C755}

#loading{text-align:center;padding:60px 0;color:#999}
</style>
</head>

<body>

<header>
<h1>LINEスタンプ一覧</h1>
<div class="controls">
<button id="allBtn">すべて</button>
<button id="authorBtn">作者別</button>
<input type="text" id="searchInput" placeholder="スタンプ名・作者名で検索">
</div>
</header>

<main>
<div id="app"><div id="loading">読み込み中...</div></div>
</main>

<script>

const GAS_JSON_URL = "https://script.google.com/macros/s/AKfycbzjumzsSjuuAHV02Mvf2L3YaksqxQfgFGQwdKIFz4T0kRQaqnvyM4XjNqEVCRznjBkmyA/exec?format=json";

let globalData = null;
let currentView = "all";
let currentSearch = "";

init();

function init(){
  document.getElementById("searchInput").value = currentSearch;

  fetch(GAS_JSON_URL)
    .then(r => r.json())
    .then(data => {
      globalData = data;
      render();
    })
    .catch(() => {
      document.getElementById("app").innerHTML = "<p>データの読み込みに失敗しました。</p>";
    });

  document.getElementById("allBtn").onclick = () => {
    currentView = "all";
    render();
  };

  document.getElementById("authorBtn").onclick = () => {
    currentView = "author";
    render();
  };

  document.getElementById("searchInput").oninput = (e) => {
    currentSearch = e.target.value;
    render();
  };
}

/* ========================================
   描画
======================================== */
function render(){
  if(!globalData) return;

  let authors = globalData.authors;

  /* --- 検索フィルタ --- */
  if(currentSearch){
    const q = currentSearch.toLowerCase();
    authors = authors.map(a => {
      const matched =
        (a.creatorName || "").toLowerCase().includes(q) ||
        (a.snsName || "").toLowerCase().includes(q);

      const stamps = a.stamps.filter(s =>
        matched || (s.name || "").toLowerCase().includes(q)
      );
      return { ...a, stamps };
    }).filter(a => a.stamps.length > 0);
  }

  let html = "";

  /* ================== すべて表示 ================== */
  if(currentView === "all"){

    html += '<div class="grid">';
    authors.forEach(a => {
      a.stamps.forEach(s => {
        html += stampCardHTML(s);
      });
    });
    html += '</div>';

    if(!authors.length || !authors.some(a => a.stamps.length)){
      html = '<p style="text-align:center;color:#999;padding:40px">該当するスタンプがありません</p>';
    }
  }

  /* ================== 作者別表示 ================== */
  if(currentView === "author"){

    const named = authors.filter(a => !a.isAnonymous);
    const anon  = authors.filter(a => a.isAnonymous);

    /* 名前あり → 作者セクション */
    named.forEach(a => {
      html += '<div class="author-section">';
      html += '<div class="author-header">';

      html += '<div class="author-name">';
      if(a.creatorUrl){
        html += '<a href="' + a.creatorUrl + '" target="_blank">' + esc(a.creatorName) + '</a>';
      } else {
        html += esc(a.creatorName);
      }
      html += '</div>';

      const metaParts = [];
      if(a.snsName)    metaParts.push(esc(a.snsName));
      if(a.xUrl)       metaParts.push('<a href="' + a.xUrl + '" target="_blank">X</a>');
      if(a.threadsUrl) metaParts.push('<a href="' + a.threadsUrl + '" target="_blank">Threads</a>');

      if(metaParts.length){
        html += '<div class="author-meta">' + metaParts.join(' | ') + '</div>';
      }

      html += '</div>';

      html += '<div class="grid">';
      a.stamps.forEach(s => {
        html += stampCardHTML(s);
      });
      html += '</div>';

      html += '</div>';
    });

    /* 名前なし → 見出しなし、フラットなグリッド */
    if(anon.length){
      const anonStamps = [];
      anon.forEach(a => {
        a.stamps.forEach(s => anonStamps.push(s));
      });

      if(anonStamps.length){
        html += '<div class="grid" style="margin-top:24px">';
        anonStamps.forEach(s => {
          html += stampCardHTML(s);
        });
        html += '</div>';
      }
    }

    if(!named.length && !anon.length){
      html = '<p style="text-align:center;color:#999;padding:40px">該当するスタンプがありません</p>';
    }
  }

  document.getElementById("app").innerHTML = html;

  document.getElementById("allBtn").classList.toggle("active", currentView === "all");
  document.getElementById("authorBtn").classList.toggle("active", currentView === "author");
}

/* ========================================
   スタンプカード
======================================== */
function stampCardHTML(stamp){
  return '<div class="stamp-card">' +
    '<a href="' + stamp.url + '" target="_blank">' +
      '<img src="' + (stamp.image || "") + '" alt="' + esc(stamp.name) + '" loading="lazy">' +
    '</a>' +
    '<div class="stamp-name">' + esc(stamp.name) + '</div>' +
  '</div>';
}

/* HTMLエスケープ */
function esc(str){
  if(!str) return "";
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

</script>
</body>
</html>
